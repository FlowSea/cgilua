<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <title>CGILua - Building web scripts with Lua</title>
    <link rel="stylesheet" href="http://www.keplerproject.org/doc.css" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>
<body>

<div id="container">
	
<div id="product">
	<div id="product_logo"><a href="http://www.keplerproject.org">
		<img alt="CGILua logo" src="cgi-128.gif"/>
	</a></div>
	<div id="product_name"><big><b>CGILua</b></big></div>
	<div id="product_description">Building web scripts with Lua</div>
</div> <!-- id="product" -->

<div id="main">
	
<div id="navigation">
<h1>CGILua</h1>
	<ul>
		<li><a href="index.html">Home</a>
			<ul>
				<li><a href="index.html#overview">Overview</a></li>
				<li><a href="index.html#status">Status</a></li>
				<li><a href="index.html#download">Download</a></li>
				<li><a href="index.html#history">History</a></li>
				<li><a href="index.html#incompatibility">Incompatibilities</a></li>
				<li><a href="index.html#credits">Credits</a></li>
				<li><a href="index.html#contact">Contact us</a></li>
			</ul>
		</li>
		<li><strong>Manual</strong>
			<ul>
				<li><a href="manual.html#intro">Introduction</a></li>
				<li><a href="manual.html#installation">Installation</a></li>
				<li><a href="manual.html#config">Configuration</a></li>
				<li><a href="manual.html#scripts">Lua Scripts</a></li>
				<li><a href="manual.html#templates">Lua Pages</a></li>
				<li><a href="manual.html#parameters">Parameters</a></li>
			</ul>
		</li>
		<li><a href="reference.html">Reference</a>
			<ul>
				<li><a href="reference.html#headers">Headers</a></li>
				<li><a href="reference.html#contents">Content Generation</a></li>
				<li><a href="reference.html#prep">Templates</a></li>
				<li><a href="reference.html#variables">CGILua's Variables</a></li>
				<li><a href="reference.html#error_handling">Error Handling</a></li>
				<li><a href="reference.html#behavior">CGILua Behavior</a></li>
				<li><a href="reference.html#auxiliar">Auxiliary functions</a></li>
				<li><a href="reference.html#urlcode">URL Encoding</a></li>
				<li><a href="reference.html#index">Alphabetic Index</a></li>
			</ul>
		</li>
		<li><a href="libraries.html">Libraries</a>
			<ul>
				<li><a href="libraries.html#cookies">Cookies</a></li>
				<li><a href="libraries.html#serialize">Serialize</a></li>
				<li><a href="libraries.html#session">Session</a></li>
				<li><a href="libraries.html#stable">Stable</a></li>
			</ul>
		</li>
		<li><a href="sapi.html">SAPI</a></li>
		<li><a href="examples.html">Examples</a></li>
		<li><a href="license.html">License</a></li>
	</ul>
</div> <!-- id="navigation" -->

<div id="content">

<h2><a name="intro"></a>Introduction</h2>

<p>CGILua uses <a href="http://www.lua.org">Lua</a> as a server-side scripting
language for creating dynamic Web pages. Both pure
<a href="manual.html#scripts">Lua Scripts</a> and
<a href="manual.html#templates">Lua Pages</a> (LP) are supported by CGILua.
A Lua script is essentially a Lua program that creates the whole contents of
a web page and returns it to the web server. A Lua Page is a conventional
markup text (HTML, XML etc) file that embeds Lua code using some special
tags.</p>

<p>Lua scripts and Lua Pages are equally easy to use, and choosing one of them
basically depends on the characteristics of a specific page. While Lua
Pages are more convenient for the separation of content and format, where
the format is usually manipulated with the help of a HTML editor, Lua scripts
are more adequate for creating pages that are simpler in terms of its HTML
structure, but require a significative amount of internal processing.</p>

<p>Allowing these two methods to be intermixed, CGILua provides Web applications
developers with great flexibility when both requirements are present. For a
detailed description of both scripting methods and some examples of
their use see <a href="manual.html">CGILua scripts</a>.</p>

<p>CGILua can use Java Servlet, ISAPI module, Apache module, FastCGI and
traditional CGI. CGILua's architecture is divided in two layers. The lower level
one is represented by the Server API (<a href="sapi.html">SAPI</a>) and the higher
level is represented by the CGILua API itself. The high level layer is
implemented using only SAPI and is totally portable between the launchers.
This way any CGILua script or CGILua page could be run by any launcher.</p>

<h2><a name="installation"></a>Installation</h2>

<p>
CGILua is a Lua package which follows the
<a href="http://www.keplerproject.org/compat">package model</a>
for Lua 5.1.
</p>

<p>
The whole package should be installed in a directory called
<tt>cgilua</tt>.
</p>



<h2><a name="config"></a>Configuration</h2>

<p>CGILua 5.0 offers a single configuration file,
called <code>config.lua</code>
and a set of functions to alter the default
configuration.
</p>

<a name="sys_config"></a>
<h3>CGILua configuration</h3>

<p>CGILua system configuration is placed at <code>config.lua</code>.
Some of the configuration parameters are listed below:
</p>

<ul>
  <li>
script handlers, by calling
<a href="reference.html#addscripthandler">
<code>cgilua.addscripthandler</code></a> (see also
<a href="reference.html#buildplainhandler">cgilua.buildplainhandler</a> and
<a href="reference.html#buildprocesshandler">cgilua.buildprocesshandler</a>
for functions that build simple handlers);
  </li>
  <li>
POST data sizes, by calling <a href="reference.html#setmaxinput">
<code>cgilua.setmaxinput</code></a> and <a href="reference.html#setmaxfilesize">
<code>cgilua.setmaxfilesize</code></a>;
  </li>
  <li>
opening and closing functions, by calling
<a href="reference.html#addopenfunction"><code>cgilua.addopenfunction</code></a> and
<a href="reference.html#addclosefunction"><code>cgilua.addclosefunction</code></a>.
This functions are executed just before and after the script execution,
even if an error occurs.
  </li>
</ul>

<a name="error_handling"></a>
<h3>Error Handling</h3>

<p>There are three functions to handle errors in CGILua:
</p>

<p>The function <a href="reference.html#seterrorhandler">
<code>cgilua.seterrorhandler</code></a> defines the <i>error handler</i>,
a function called by Lua when an error has just occurred. The error handler
has access to the execution stack before the error is thrown and so it can
build an error message using stack information. Lua also provides a function
to do that: <code>debug.traceback</code>.</p>

<p>The function <a href="reference.html#seterroroutput">
<code>cgilua.seterroroutput</code></a> defines the function that decides
what to do with the message.
It could be sent to the client's browser or written to the log file
or sent to an e-mail address (with the help of LuaSocket, for example).
</p>

<p>The function
<a href="reference.html#errorlog"><code>cgilua.errorlog</code></a>
is provided to write directly to the http server error log file.
</p>

<h2><a name="scripts"></a>Lua Scripts</h2>

<p>Lua scripts are text files containing valid sentences in the Lua
language. This kind of usage adopts a "traditional" form of
programming, where a program is responsible for the entire generation of the
resulting page.</p>

<p>To generate a valid web document (HTML, XML, WML, CSS etc) the script
must follow an order to produce its output, first sending the correct header
and then sending the actual document contents.</p>

<p>CGILua offers some functions to ease these tasks. The most common
is <a href="reference.html#htmlheader"><code>cgilua.htmlheader</code></a> that
produce the header for a HTML document (see <a href=
"reference.html#headers">Headers</a> for a complete list). The
function used to send the document's contents (or part of it) is <a href=
"reference.html#put"><code>cgilua.put</code></a>.</p>

<p>For example, a HTML document which displays the sentence "Hello
World!" can be generated with the following Lua script:</p>

<pre class="example">
cgilua.htmlheader()
cgilua.put([[
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Hello World&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;b&gt;Hello World!&lt;/b&gt;
&lt;/body&gt;
&lt;/html&gt;
]])
</pre>

<p>It should be noted that the above example generates a "fixed"
page: even though the page is generated at execution time there is
no "variable" information. The very same document could be
generated directly with a simple HTML file. However, Lua scripts become
especially useful when the document contains information which is
not known beforehand, and it is necessary to generate a "dynamic"
page.</p>

<p>Another easy example can be shown, this time using a Lua control
structure, variables, and the concatenation operator:</p>

<pre class="example">
cgilua.htmlheader()  
cgilua.put('&lt;html&gt;')  

if cgi.language == 'english' then
    greeting = 'Hello World!'
elseif cgi.language == 'portuguese' then
    greeting = 'Ol&aacute; Mundo!'
else
    greeting = '[unknown language]'
end

cgilua.put('&lt;head&gt;&lt;title&gt;'..greeting..'&lt;/title&gt;&lt;/head&gt;')
cgilua.put('&lt;body&gt;')
cgilua.put('&lt;b&gt;'..greeting..'&lt;/b&gt;')
cgilua.put('&lt;/body&gt;')
cgilua.put('&lt;/html&gt;')
</pre>

<p>The use of <code><i>cgi.language</i></code> indicates that a
variable named "language" was passed to the script as a CGI
parameter, coming from a HTML form field (via POST) or from the URL used to
activate it (via GET). CGILua automatically decodes such variables.</p>


<h2><a name="templates"></a>Lua Pages</h2>

<p>A Lua Page is a text template file which will be processed by CGILua
before the HTTP server sends it to the client. CGILua does not
process the text itself but it searches some special markups that include Lua
code into the file. After all those markups are processed, the
resulting file is sent to the client.</p>

<p>Lua Pages have a default <code>.lp</code> extension. They are a simpler
way to make a dynamic page because there is no need to send the HTTP header,
usually Lua Pages are HTML pages so CGILua sends the HTML header automatically.
But there are some restrictions on the use of Lua Pages and and sometimes
a Lua Script will have to be used.</p>

<p>The fundamental markups is:</p>

<pre class="example">
<code>&lt;?lua
<i>Lua chunk</i>
?&gt;
</code>
</pre>

There are also some alternatives accepted: 

<ul>
<li><code>&lt;?lua= <i>Lua expression</i> ?&gt;</code></li>

<li><code>&lt;% <i>Lua chunk</i> %&gt;</code></li>

<li><code>&lt;%= <i>Lua expression</i> %&gt;</code></li>
</ul>

Note that the ending mark could not appear inside a Lua chunk or
Lua expression even inside quotes. CGILua pre-processor just
makes global substitutions searching for a pair of markups and
building the corresponding Lua code to achieve the same result as the equivalent
Lua Script. 

<p>The example on the previous section could be written using a
Lua Page:</p>

<pre class="example">
<code>&lt;html&gt;
&lt;?lua
if cgi.language == 'english' then
        greeting = 'Hello World!'
elseif cgi.language == 'portuguese' then
        greeting = 'Ol&aacute; Mundo!'
else
        greeting = '[unknown language]'
end
?&gt;
&lt;head&gt;&lt;title&gt;&lt;%= greeting %&gt;&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;b&gt;&lt;%= greeting %&gt;&lt;/b&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</pre>

<p>As on other template languages, it's considered a best practice to not use
explicit Lua logic on Lua Pages, the recommended aproach is to use only
function calls that returns chunks of the page</p>


<h2><a name="parameters"></a>Receiving parameters: the <code>cgi</code> table</h2>

<p>CGILua has an unified way of accessing data passed to the script
despite the HTTP method used (GET or POST). No matter which method was used on
the client, all parameters will be provided inside the <b>cgi table</b>.</p>

<p>Almost all types of parameters will be available as strings. Even if
the value of a parameter is a number, it will be converted to its
string representation.</p>

<p>There are only two exceptions where the value will be a Lua table.
The first case occurs on file uploads, where the table will have the
following fields:</p>

<ul>
<li><b>filename</b> the file name as given by the client.</li>

<li><b>filesize</b> the file size in bytes.</li>

<li><b>file</b> the temporary file handle. The file must be copied
because CGILua's will remove it after the script ends.</li>
</ul>

<p>The other case that uses Lua tables occurs when
there is more than one value associated with the same parameter
name. This happens in the case of a selection list with multiple values; but it
also occurs when the form (of the referrer) had two or more
elements with the same <code>name</code> attribute (maybe because one was on a
form and another was in the query string). All values will be inserted
in an indexed table in the order in which they are treated.</p>

</div> <!-- id="content" -->

</div> <!-- id="main" -->

<div id="about">
	<p><a href="http://validator.w3.org/check?uri=referer"><img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0!" height="31" width="88" /></a></p>
	<p><small>
	$Id: manual.html,v 1.1 2005/07/14 15:50:37 carregal Exp $
	</small></p>
</div> <!-- id="about" -->

</div> <!-- id="container" -->

</body>
</html> 
